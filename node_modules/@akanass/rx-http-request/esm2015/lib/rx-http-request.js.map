{"version":3,"file":"rx-http-request.js","sourceRoot":"","sources":["../../../src/lib/rx-http-request.ts"],"names":[],"mappings":"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","sourcesContent":["// import libraries\nimport * as request from 'request';\nimport { Buffer } from 'buffer';\n\nimport RequestAPI = request.RequestAPI;\nimport Request = request.Request;\nimport CoreOptions = request.CoreOptions;\nimport RequiredUriUrl = request.RequiredUriUrl;\nimport RequestResponse = request.RequestResponse;\nimport RequestCallback = request.RequestCallback;\n\nimport { Observable ,  of , merge,  throwError } from 'rxjs';\nimport { filter, tap, flatMap, map } from 'rxjs/operators';\n\n\nimport { RxCookieJar, Cookie } from './rx-cookie-jar';\n\n// native javascript's objects typings\ndeclare const Object: any;\n\n/**\n * Class definition\n */\nexport class RxHttpRequest {\n    // private property to store singleton instance\n    private static _instance: RxHttpRequest;\n    // private property to store request API object\n    private readonly _request: RequestAPI<Request, CoreOptions, RequiredUriUrl>;\n\n    /**\n     * Returns singleton instance\n     *\n     * @return {RxHttpRequest}\n     */\n    static instance(): RxHttpRequest {\n        if (!(RxHttpRequest._instance instanceof RxHttpRequest)) {\n            RxHttpRequest._instance = new RxHttpRequest(request);\n        }\n\n        return RxHttpRequest._instance;\n    }\n\n    /**\n     * Class constructor\n     */\n    constructor(req: RequestAPI<Request, CoreOptions, RequiredUriUrl>) {\n        // check request parameter\n        this._checkRequestParam(req);\n\n        // set request object\n        this._request = req;\n    }\n\n    /**\n     * Returns private attribute _request\n     *\n     * @return {RequestAPI<Request, CoreOptions, RequiredUriUrl>}\n     */\n    get request(): RequestAPI<Request, CoreOptions, RequiredUriUrl> {\n        return this._request;\n    }\n\n    /**\n     * This method returns a wrapper around the normal rx-http-request API that defaults to whatever options\n     * you pass to it.\n     * It does not modify the global rx-http-request API; instead, it returns a wrapper that has your default settings\n     * applied to it.\n     * You can _call .defaults() on the wrapper that is returned from rx-http-request.defaults to add/override defaults\n     * that were previously defaulted.\n     *\n     * @param options\n     *\n     * @return {RxHttpRequest}\n     */\n    defaults(options: CoreOptions): RxHttpRequest {\n        return new RxHttpRequest(this._request.defaults(options));\n    }\n\n    /**\n     * Function to do a GET HTTP request\n     *\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    get<R = any>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> this._call<R>('get', <string> uri,\n            <CoreOptions> Object.assign({}, options || {}));\n    }\n\n    /**\n     * Function to do a GET HTTP request and to return a buffer\n     *\n     * @param uri\n     * @param options\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    getBuffer<R = Buffer>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> Observable.create((observer) => {\n            try {\n                this._request.get(<string> uri, <CoreOptions> Object.assign({}, options || {}))\n                    .on('response', (response: RequestResponse) => {\n                        let res: Buffer;\n                        response.on('data', (data: Buffer) => res = res ? Buffer.concat([].concat(res, data)) : data);\n                        response.on('end', _ => {\n                            observer.next(<RxHttpRequestResponse<Buffer>> Object.assign({}, {\n                                response: <RequestResponse> response,\n                                body: <Buffer> res\n                            }));\n                            observer.complete();\n                        });\n                    })\n                    .on('error', /* istanbul ignore next */ error => observer.error(error));\n            } catch (error) {\n                observer.error(error);\n            }\n        });\n    }\n\n    /**\n     * Function to do a POST HTTP request\n     *\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    post<R = any>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> this._call<R>('post', <string> uri,\n            <CoreOptions> Object.assign({}, options || {}));\n    }\n\n    /**\n     * Function to do a PUT HTTP request\n     *\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    put<R = any>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> this._call<R>('put', <string> uri,\n            <CoreOptions> Object.assign({}, options || {}));\n    }\n\n    /**\n     * Function to do a PATCH HTTP request\n     *\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    patch<R = any>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> this._call<R>('patch', <string> uri,\n            <CoreOptions> Object.assign({}, options || {}));\n    }\n\n    /**\n     * Function to do a DELETE HTTP request\n     *\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    delete<R = any>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> this._call<R>('del', <string> uri,\n            <CoreOptions> Object.assign({}, options || {}));\n    }\n\n    /**\n     * Function to do a HEAD HTTP request\n     *\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     */\n    head<R = any>(uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> this._call<R>('head', <string> uri,\n            <CoreOptions> Object.assign({}, options || {}));\n    }\n\n    /**\n     * Function that creates a new rx cookie jar\n     *\n     * @return {Observable<RxCookieJar>}\n     */\n    jar(): Observable<RxCookieJar> {\n        return <Observable<RxCookieJar>> of(new RxCookieJar(this._request.jar()));\n    }\n\n    /**\n     * Function that creates a new cookie\n     *\n     * @param str {string}\n     *\n     * @return {Observable<Cookie>}\n     */\n    cookie(str: string): Observable<Cookie> {\n        return <Observable<Cookie>> of(this._request.cookie(<string> str));\n    }\n\n    /**\n     * Function to do a HTTP request for given method\n     *\n     * @param method {string}\n     * @param uri {string}\n     * @param options {CoreOptions}\n     *\n     * @return {Observable<RxHttpRequestResponse<R>>}\n     *\n     * @private\n     */\n    private _call<R = any>(method: string, uri: string, options?: CoreOptions): Observable<RxHttpRequestResponse<R>> {\n        return <Observable<RxHttpRequestResponse<R>>> Observable.create((observer) => {\n            of([].concat(<string> uri, <CoreOptions> Object.assign({}, options || {}),\n                <RequestCallback> ((error: any, response: RequestResponse, body: R) => {\n                    of(of(error))\n                        .pipe(\n                            flatMap(obsError =>\n                                merge(\n                                    obsError\n                                        .pipe(\n                                            filter(_ => !!_),\n                                            tap(err => observer.error(err))\n                                        ),\n                                    obsError\n                                        .pipe(\n                                            filter(_ => !_),\n                                            flatMap(_ =>\n                                                !!response ?\n                                                    <Observable<RequestResponse>> of(response) :\n                                                    throwError(new Error('No response found'))\n                                            ),\n                                            flatMap(_ =>\n                                                of({\n                                                    response: <RequestResponse> _,\n                                                    body: <R> body\n                                                })\n                                            ),\n                                            tap(_ => observer.next(_)),\n                                            tap(_ => observer.complete())\n                                        )\n                                )\n                            )\n                        )\n                        .subscribe(undefined, err => observer.error(err));\n                })))\n                .pipe(\n                    map(_ => this._request[<string> method].apply(<RequestAPI<Request, CoreOptions, RequiredUriUrl>> this._request, _)),\n                )\n                .subscribe(undefined, err => observer.error(err));\n        });\n    }\n\n    /**\n     * Function to check existing function in request API passed in parameter for a new instance\n     *\n     * @param req {RequestAPI<Request, CoreOptions, RequiredUriUrl>}\n     *\n     * @private\n     */\n    private _checkRequestParam(req: RequestAPI<Request, CoreOptions, RequiredUriUrl>) {\n        // check existing function in API\n        if (!req ||\n            Object.prototype.toString.call(req.get) !== '[object Function]' ||\n            Object.prototype.toString.call(req.head) !== '[object Function]' ||\n            Object.prototype.toString.call(req.post) !== '[object Function]' ||\n            Object.prototype.toString.call(req.put) !== '[object Function]' ||\n            Object.prototype.toString.call(req.patch) !== '[object Function]' ||\n            Object.prototype.toString.call(req.del) !== '[object Function]' ||\n            Object.prototype.toString.call(req.defaults) !== '[object Function]' ||\n            Object.prototype.toString.call(req.jar) !== '[object Function]' ||\n            Object.prototype.toString.call(req.cookie) !== '[object Function]') {\n            throw new TypeError('Parameter must be a valid `request` module API');\n        }\n    }\n}\n\n/**\n * Export {RxHttpRequest} instance\n */\nexport const RxHR: RxHttpRequest = RxHttpRequest.instance();\n\n/**\n * Export response interface\n */\nexport interface RxHttpRequestResponse<R = any> {\n    response: RequestResponse;\n    body: R;\n}\n\n/**\n * Export all initial elements\n */\nexport { RequestAPI, Request, CoreOptions, RequiredUriUrl, RequestResponse };\n"]}